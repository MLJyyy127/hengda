{% extends 'base.html' %}
{% load static %} 
{%load widget_tweaks %}
{% block title %} 人才招聘 {% endblock %} 

{% block content %} 
<link href="{% static 'css/contact.css' %}" rel="stylesheet" />
<link rel="stylesheet" href="{% static 'js/layui-v2.13.1/layui/css/layui.css' %}">

<style>
    /* 保护 Bootstrap 网格系统 */
    .row > [class*="col-"] { float: left !important; position: static !important; }
    .col-md-2.hidden-xs { width: auto !important; }

    /* 实时验证错误样式 */
    .error-field {
        border-color: #ff4d4f !important;
        background-color: #fff2f0 !important;
        box-shadow: 0 0 0 2px rgba(255, 77, 79, 0.2) !important;
    }
    .error-message {
        color: #ff4d4f;
        font-size: 12px;
        display: block;
        margin-top: 5px;
        font-weight: bold;
    }
    /* 经历字数统计 */
    #char-count { text-align: right; color: #999; font-size: 12px; }
</style>

<script src="{% static 'js/layui-v2.13.1/layui/layui.js' %}"></script>

<div class="container-fluid">
    <div class="row" >
        <img class="img-responsive model-img" src="{% static 'img/recruit1.jpg' %}" />
    </div>
</div>

<div class="container main">
    <div class="row row-3">
        <div class="col-md-3">
            <div class="model-title">人才招聘</div>
            <div class="model-list">
                <ul class="list-group">
                    <li class="list-group-item" id="contact"><a href="{% url 'contactApp:contact' %}">欢迎咨询</a></li>
                    <li class="list-group-item" id="recruit"><a href="{% url 'contactApp:recruit' %}">加入恒达</a></li>
                </ul>
            </div>
        </div>

        <div class="col-md-9">
            <div class="model-details">
                {% for ad in AdList %}
                <div class="recruit-panel" style="border: 1px solid #eee; margin-bottom: 20px; border-radius: 4px;">
                    <div class="panel-header" onclick="toggleRecruitPanel(this)" style="padding: 15px; cursor: pointer; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                        <h4 style="margin: 0;">
                            {{ad.title}}
                            <span class="hot-tag"><i class="fa fa-fire"></i> {{ ad.apply_count }} 人已投递</span>
                        </h4>
                        <span class="arrow">▼</span>
                    </div>
                    <div class="panel-content" {% if forloop.first %}style="display:block"{% else %}style="display:none"{% endif %} style="padding: 15px; border-top: 1px solid #eee;">
                        <div class="panel-body">
                            <p><strong>岗位要求：</strong></p>
                            <p>{{ad.description}}</p>
                            
                            <div style="margin-top: 20px;">
                                <h5 style="color: #005197;"><i class="fa fa-map-signs"></i> 标准应聘流程：</h5>
                                <ul class="hiring-steps">
                                    <li class="step-node {% if ad.some_status_logic %}active{% endif %}">
                                    <li class="step-node active">
                                        <span class="step-circle">1</span>
                                        <span class="step-text">简历投递</span>
                                    </li>
                                    <li class="step-node">
                                        <span class="step-circle">2</span>
                                        <span class="step-text">初选审核</span>
                                    </li>
                                    <li class="step-node">
                                        <span class="step-circle">3</span>
                                        <span class="step-text">复试考核</span>
                                    </li>
                                    <li class="step-node">
                                        <span class="step-circle">4</span>
                                        <span class="step-text">收到通知</span>
                                    </li>
                                </ul>
                            </div>
                            <button type="button" class="btn btn-primary btn-sm" onclick="quickApply('{{ad.id}}')">立即应聘</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="panel panel-default">    
                <div class="panel-heading">请填写个人简历</div>            
                <div class="panel-body">
                    <div class="row">
                        <form id="resumeForm" action="." class="form-horizontal" method="post" role="form" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="col-md-6"> 
                                <div class="form-group">
                                    <label class="col-sm-3 control-label required-label">姓名:</label>
                                    <div class="col-sm-9">
                                        {{resumeForm.name|add_class:"form-control"|attr:"placeholder=请填写姓名"}}
                                        <span id="nameError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">身份证号：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.personID|add_class:"form-control"|attr:"placeholder=请填写身份证号"}}
                                        <span id="personIDError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">性别：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.sex|add_class:"form-control"}}
                                        <span id="sexError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label for="id_birth" class="col-sm-3 control-label required-label">出生日期：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.birth|add_class:"form-control"|attr:"id=id_birth"|attr:"readonly=readonly"}}
                                        <span id="birthError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">邮箱：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.email|add_class:"form-control"|attr:"placeholder=example@domain.com"}}
                                        <span id="emailError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">学历：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.edu|add_class:"form-control"}}
                                        <span id="eduError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">毕业院校：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.school|add_class:"form-control"|attr:"placeholder=请填写毕业院校"}}
                                        <span id="schoolError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">专业：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.major|add_class:"form-control"|attr:"placeholder=请填写专业"}}
                                        <span id="majorError" class="error-message"></span>
                                    </div>
                                </div>
                                <div class="form-group"> 
                                    <label class="col-sm-3 control-label required-label">申请职位：</label>
                                    <div class="col-sm-9"> 
                                        {{resumeForm.ad|add_class:"form-control"|attr:"id=id_ad"|attr:"placeholder=请填写申请职位"}}
                                        <span id="adError" class="error-message"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-6"> 
                                <div class="form-group"> 
                                    <div class="col-sm-12" style="text-align:center"> 
                                        <img id="profileshow" style="width:120px; height:140px; border:1px solid #ddd;" src="{% static 'img/sample.jpg' %}">
                                    </div>
                                    <label class="col-sm-5 control-label required-label">上传证件照片：</label>
                                    {{resumeForm.photo}}
                                    <span id="photoError" class="error-message"></span>
                                </div>
                                <div class="form-group">                             
                                    <label class="col-sm-12 control-label required-label">学习或工作经历：</label>
                                    <div class="col-sm-12">
                                        <div id="char-count">0 / 500 字</div>
                                        {{resumeForm.experience|add_class:"form-control"|attr:"rows=6"|attr:"placeholder=请详细描述您的学习或工作经历..."}}
                                        <span id="experienceError" class="error-message"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <center><input type="submit" class="btn btn-primary" style="width:150px" value="提交"></center>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. 保留原有的折叠面板功能
    function toggleRecruitPanel(header) {
        var content = header.nextElementSibling;
        var arrow = header.querySelector('.arrow');
        if (content.style.display === 'block') {
            content.style.display = 'none';
            arrow.style.transform = 'rotate(0deg)';
        } else {
            content.style.display = 'block';
            arrow.style.transform = 'rotate(180deg)';
        }
    }

    // 2. 保留原有的照片预览功能
    $(function(){
        $('#id_photo').on('change', function() {
            var r = new FileReader();
            var f = this.files[0];
            if (f) {
                r.readAsDataURL(f);
                r.onload = function(e){
                    document.getElementById('profileshow').src = this.result;
                };
                validateSingleField('id_photo'); // 实时验证
            }
        });
    });

    // 3. 增强的校验逻辑（包含18岁限制和正则）
    function isAdult(birthDate) {
        if(!birthDate) return false;
        var parts = birthDate.split('-');
        var birth = new Date(parts[0], parts[1] - 1, parts[2]);
        var today = new Date();
        var age = today.getFullYear() - birth.getFullYear();
        var m = today.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
        return age >= 18;
    }

    function validateSingleField(fieldId) {
        var $el = $('#' + fieldId);
        var val = $el.val() ? $el.val().trim() : "";
        var errorId = fieldId.replace('id_', '') + 'Error';
        var msg = "";

        // 根据 ID 执行不同的验证规则
        switch(fieldId) {
            case 'id_name':
                if(!val) msg = "请输入姓名";
                break;
            case 'id_personID':
                if(!val) msg = "请输入身份证号";
                else if(!/^\d{17}[\dXx]$/.test(val)) msg = "身份证号格式不正确";
                break;
            case 'id_email':
                if(!val) msg = "请输入邮箱";
                else if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)) msg = "邮箱格式不正确";
                break;
            case 'id_birth':
                if(!val) msg = "请选择出生日期";
                else if(!isAdult(val)) msg = "必须年满18周岁";
                break;
            case 'id_experience':
                if(!val) msg = "请输入经历";
                else if(val.length < 10) msg = "至少填写10个字";
                $('#char-count').text(val.length + ' / 500 字');
                break;
            case 'id_photo':
                if(!$el.val()) msg = "请上传照片";
                break;
            case 'id_ad':
                if(!val) msg = "请选择申请职位";
                break;
            
            default:
                if(!val && $el.prop('required')) msg = "此项必填";
        }

        if(msg) {
            $el.addClass('error-field');
            $('#' + errorId).text(msg);
            return false;
        } else {
            $el.removeClass('error-field');
            $('#' + errorId).text('');
            return true;
        }
    }

    // 4. 绑定实时事件 (input, change, blur)
    $(document).ready(function() {
        // Laydate 初始化并绑定实时校验
        layui.use('laydate', function(){
            layui.laydate.render({
                elem: '#id_birth',
                trigger: 'click',
                done: function(value){
                    $('#id_birth').val(value);
                    validateSingleField('id_birth');
                }
            });
        });

        // 绑定文本框输入事件
        $('#id_name, #id_personID, #id_email, #id_school, #id_major, #id_experience').on('input blur', function() {
            validateSingleField($(this).attr('id'));
        });

        // 绑定下拉框
        $('#id_sex, #id_edu').on('change', function() {
            validateSingleField($(this).attr('id'));
        });

        // 5. 最终提交验证（兜底）
        $('#resumeForm').on('submit', function(e) {
            var fields = ['id_name', 'id_personID', 'id_sex', 'id_birth', 'id_email', 'id_edu', 'id_school', 'id_major', 'id_ad', 'id_photo', 'id_experience'];
            var allValid = true;
            fields.forEach(function(id) {
                if(!validateSingleField(id)) allValid = false;
            });

            if(!allValid) {
                e.preventDefault();
                $('html, body').animate({
                    scrollTop: $('.error-field').first().offset().top - 100
                }, 500);
                return false;
            }
        });
    });

    
    // 快速定位并填充职位的脚本
    function quickApply(jobId) {
        // 名字变了，ID也会变，Django默认生成的是 id_ad
        $('#id_ad').val(jobId); 
        $('html, body').animate({ scrollTop: $("#resumeForm").offset().top - 50 }, 500);
    }
    
</script>
{% endblock %}